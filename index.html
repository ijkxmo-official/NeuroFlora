<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroFlora</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
    <style>
        :root {
            --primary: #10a37f;
            --primary-light: rgba(16, 163, 127, 0.08);
            --primary-dark: #0d8c6d;
            --accent: #6e41e2;
            --success: #10a37f;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f1f3f5;
            --bg-sidebar: #fafafa;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --text-tertiary: #8e8e93;
            --text-muted: #999999;
            --border: #e9ecef;
            --border-light: #f1f3f5;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);
            --radius: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --radius-xs: 6px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --sidebar-width: 300px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            display: flex;
            height: 100vh;
            height: -webkit-fill-available;
            overflow: hidden;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition);
            z-index: 1000;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-toggle-btn {
            position: absolute;
            top: 20px;
            left: 100%;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            z-index: 1001;
            transition: var(--transition);
            box-shadow: var(--shadow);
            margin-left: 8px;
        }

        .sidebar.hidden .sidebar-toggle-btn {
            left: 0;
            transform: translateX(0);
        }

        .sidebar-toggle-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 20px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 18px;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
        }

        .new-chat-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 12px 0;
        }

        .new-chat-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .sidebar-nav {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 20px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            margin: 0 12px;
            border-radius: var(--radius-md);
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 500;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }

        .history-section {
            flex: 1;
            overflow-y: auto;
            padding: 0 12px 20px;
        }

        .history-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 20px 8px 8px;
            position: sticky;
            top: 0;
            background: var(--bg-sidebar);
            z-index: 1;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .history-item {
            padding: 14px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            border: 1px solid transparent;
            position: relative;
        }

        .history-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-light);
        }

        .history-item:hover .history-delete-btn {
            opacity: 1;
        }

        .history-item.active {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .history-preview {
            flex: 1;
            min-width: 0;
            padding-right: 30px;
        }

        .history-text {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
            font-weight: 500;
            line-height: 1.4;
        }

        .history-time {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .history-delete-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: var(--radius-xs);
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
        }

        .history-delete-btn:hover {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            margin-left: 0;
            transition: margin-left var(--transition);
            position: relative;
            overflow: hidden;
        }

        .sidebar:not(.hidden) ~ .main-content {
            margin-left: var(--sidebar-width);
        }

        .main-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-primary);
            z-index: 100;
            flex-shrink: 0;
            min-height: 64px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 0;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .menu-toggle:hover {
            background: var(--bg-tertiary);
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 140px;
            scroll-behavior: smooth;
        }

        .welcome-message {
            max-width: 100%;
            margin: 0 auto;
            text-align: center;
            padding: 40px 20px;
            width: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .welcome-message.show {
            display: flex;
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            background-image: url('https://i.postimg.cc/vBCd4Vpk/Bez-nazvania55-20251215013207.png');
            background-size: 120%;
            background-repeat: no-repeat;
            background-position: center;
            margin-bottom: 24px;
            border: 2px solid var(--border);
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.5px;
        }

        .welcome-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.5;
            max-width: 500px;
        }

        .example-questions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 32px;
            width: 100%;
            max-width: 640px;
        }

        .example-card {
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
        }

        .example-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .example-text {
            font-size: 15px;
            line-height: 1.5;
            color: var(--text-primary);
        }

        .message {
            display: flex;
            margin-bottom: 16px;
            max-width: 100%;
            animation: fadeIn 0.3s ease-out;
        }

        .user-message {
            justify-content: flex-end;
        }

        .message-container {
            display: flex;
            max-width: 85%;
            align-items: flex-start;
            gap: 12px;
        }

        .user-message .message-container {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 14px;
        }

        .user-avatar-sm {
            background-color: var(--primary);
            color: white;
        }

        .bot-avatar-sm {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            background-image: url('https://i.postimg.cc/SxdqDwpy/Bez-nazvania54-20251214232638.png');
        }

        .message-content-wrapper {
            flex: 1;
            min-width: 0;
            max-width: 100%;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-author {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
        }

        .message-time {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .message-content {
            background: var(--bg-secondary);
            border-radius: 18px;
            padding: 12px 16px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 15px;
            border: 1px solid transparent;
        }

        .user-message .message-content {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .bot-message .message-content {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 12px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .action-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            max-width: 85%;
            margin-bottom: 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
            padding: 16px 20px 20px;
            transition: left var(--transition);
            z-index: 100;
        }

        .sidebar:not(.hidden) ~ .input-container {
            left: var(--sidebar-width);
        }

        .input-wrapper {
            max-width: 100%;
            margin: 0 auto;
            position: relative;
            width: 100%;
        }

        .input-area {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 15px;
            font-family: var(--font-family);
            background: var(--bg-primary);
            color: var(--text-primary);
            resize: none;
            max-height: 120px;
            min-height: 52px;
            line-height: 1.5;
            transition: var(--transition);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.1);
        }

        .input-field::placeholder {
            color: var(--text-tertiary);
        }

        .send-button {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 12px;
            color: var(--text-tertiary);
            flex-wrap: wrap;
            gap: 8px;
        }

        .char-count {
            flex-shrink: 0;
        }

        .ai-disclaimer {
            font-size: 11px;
            color: var(--text-muted);
            text-align: center;
            margin-top: 12px;
            padding: 8px;
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            line-height: 1.4;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .settings-modal {
            background: var(--bg-primary);
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
            border: 1px solid var(--border);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-primary);
            position: sticky;
            top: 0;
            z-index: 1;
            border-radius: var(--radius) var(--radius) 0 0;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            background: var(--bg-secondary);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-content {
            padding: 24px;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .stat-card {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 6px;
            line-height: 1;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .language-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
        }

        .language-option {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .language-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .language-option.active {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary);
        }

        .checkmark {
            color: var(--primary);
            font-size: 14px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 320px;
                transform: translateX(-100%);
                box-shadow: var(--shadow-lg);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle-btn {
                display: none;
            }

            .menu-toggle {
                display: flex;
            }

            .main-header {
                padding: 12px 16px;
                min-height: 56px;
            }

            .chat-container {
                padding: 16px;
                padding-bottom: 140px;
            }

            .input-container {
                padding: 12px 16px 16px;
                left: 0 !important;
            }

            .welcome-message {
                padding: 32px 16px;
            }

            .welcome-title {
                font-size: 24px;
            }

            .welcome-subtitle {
                font-size: 15px;
                margin-bottom: 24px;
            }

            .example-questions {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-top: 24px;
            }

            .example-card {
                padding: 16px;
            }

            .message-container {
                max-width: 90%;
            }

            .message-content {
                padding: 14px;
            }

            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-value {
                font-size: 22px;
            }

            .language-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .language-option {
                padding: 14px 12px;
                font-size: 14px;
            }

            .history-delete-btn {
                opacity: 1;
            }

            .sidebar:not(.hidden) ~ .main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .language-grid {
                grid-template-columns: 1fr;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
            }

            .input-field {
                padding: 12px 14px;
                min-height: 48px;
            }

            .send-button {
                width: 40px;
                height: 40px;
            }

            .sidebar-header {
                padding: 16px;
            }

            .user-avatar {
                width: 44px;
                height: 44px;
                font-size: 16px;
            }

            .nav-item {
                padding: 12px 16px;
                margin: 0 8px;
            }

            .message-container {
                max-width: 95%;
            }
        }

        .dark-theme {
            --primary: #10a37f;
            --primary-light: rgba(16, 163, 127, 0.15);
            --accent: #8b5cf6;
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3d3d3d;
            --bg-sidebar: #252525;
            --bg-card: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-tertiary: #8e8e93;
            --text-muted: #6b7280;
            --border: #404040;
            --border-light: #333333;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .mobile-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle-btn" id="sidebar-toggle">
                <i class="fas fa-chevron-right"></i>
            </button>
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                        <div class="user-status">
                            <span class="status-dot"></span>
                            <span id="user-status-text">–û–Ω–ª–∞–π–Ω</span>
                        </div>
                    </div>
                </div>
                <button class="new-chat-btn" id="new-chat-btn">
                    <i class="fas fa-plus"></i>
                    <span id="new-chat-text">–ù–æ–≤—ã–π —á–∞—Ç</span>
                </button>
            </div>

            <div class="sidebar-nav">
                <div class="nav-item active" data-tab="chat">
                    <i class="fas fa-comment"></i>
                    <span id="chat-tab-text">–ß–∞—Ç</span>
                </div>
                <div class="nav-item" id="settings-btn">
                    <i class="fas fa-cog"></i>
                    <span id="settings-tab-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                </div>
            </div>

            <div class="history-section">
                <div class="history-title">
                    <span id="history-title-text">–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</span>
                </div>
                <div class="history-list" id="history-list"></div>
            </div>
        </div>

        <div class="mobile-overlay" id="mobile-overlay"></div>

        <div class="main-content">
            <div class="main-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="chat-title" id="current-chat-title">NeuroFlora</div>
                </div>
                <div class="header-actions">
                    <button class="header-btn" id="theme-toggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="header-btn" id="clear-chat">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="chat-area">
                <div class="chat-container" id="chat-container">
                    <div class="welcome-message" id="welcome-message">
                        <div class="welcome-icon"></div>
                        <h1 class="welcome-title" id="welcome-title">NeuroFlora</h1>
                        <p class="welcome-subtitle" id="welcome-subtitle">
                            –í–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å–∞–¥–æ–≤–æ–¥—Å—Ç–≤—É. –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö,<br>
                            —É—Ö–æ–¥–µ –∑–∞ –Ω–∏–º–∏, –±–æ–ª–µ–∑–Ω—è—Ö –∏ —É–¥–æ–±—Ä–µ–Ω–∏—è—Ö.
                        </p>
                        <div class="example-questions" id="example-questions">
                            <div class="example-card" data-question="–ö–∞–∫ —É—Ö–∞–∂–∏–≤–∞—Ç—å –∑–∞ –æ—Ä—Ö–∏–¥–µ–µ–π?">
                                <div class="example-text">–ö–∞–∫ —É—Ö–∞–∂–∏–≤–∞—Ç—å –∑–∞ –æ—Ä—Ö–∏–¥–µ–µ–π?</div>
                            </div>
                            <div class="example-card" data-question="–ü–æ—á–µ–º—É –∂–µ–ª—Ç–µ—é—Ç –ª–∏—Å—Ç—å—è —É —Ñ–∏–∫—É—Å–∞?">
                                <div class="example-text">–ü–æ—á–µ–º—É –∂–µ–ª—Ç–µ—é—Ç –ª–∏—Å—Ç—å—è —É —Ñ–∏–∫—É—Å–∞?</div>
                            </div>
                            <div class="example-card" data-question="–ö–∞–∫–∏–µ —É–¥–æ–±—Ä–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Ä–æ–∑?">
                                <div class="example-text">–ö–∞–∫–∏–µ —É–¥–æ–±—Ä–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Ä–æ–∑?</div>
                            </div>
                            <div class="example-card" data-question="–ö–∞–∫ —á–∞—Å—Ç–æ –ø–æ–ª–∏–≤–∞—Ç—å –∫–∞–∫—Ç—É—Å—ã?">
                                <div class="example-text">–ö–∞–∫ —á–∞—Å—Ç–æ –ø–æ–ª–∏–≤–∞—Ç—å –∫–∞–∫—Ç—É—Å—ã?</div>
                            </div>
                        </div>
                    </div>
                    <div id="messages-container"></div>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <div class="input-area">
                        <textarea class="input-field" id="message-input" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö..." rows="1" maxlength="2000"></textarea>
                        <button class="send-button" id="send-button">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="input-footer">
                        <div class="char-count">0/2000</div>
                        <div>NeuroFlora AI</div>
                    </div>
                    <div class="ai-disclaimer" id="ai-disclaimer">
                        –û—Ç–≤–µ—Ç—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º –∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—à–∏–±–∫–∏. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="settings-modal">
            <div class="settings-modal">
                <div class="modal-header">
                    <div class="modal-title">
                        <i class="fas fa-cog"></i>
                        <span id="modal-title-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    </div>
                    <button class="modal-close" id="modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="settings-section">
                        <div class="section-title">
                            <i class="fas fa-chart-bar"></i>
                            <span id="stats-title-text">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-total">0</div>
                                <div class="stat-label" id="total-questions-text">–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-helpful">0%</div>
                                <div class="stat-label" id="helpful-answers-text">–ü–æ–ª–µ–∑–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-language">RU</div>
                                <div class="stat-label" id="language-text">–Ø–∑—ã–∫</div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <div class="section-title">
                            <i class="fas fa-language"></i>
                            <span id="interface-language-text">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</span>
                        </div>
                        <div class="language-grid">
                            <div class="language-option active" data-lang="ru">
                                üá∑üá∫ –†—É—Å—Å–∫–∏–π
                                <span class="checkmark"></span>
                            </div>
                            <div class="language-option" data-lang="en">
                                üá∫üá∏ English
                                <span class="checkmark"></span>
                            </div>
                            <div class="language-option" data-lang="uk">
                                üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞
                                <span class="checkmark"></span>
                            </div>
                            <div class="language-option" data-lang="be">
                                üáßüáæ –ë–µ–ª–∞—Ä—É—Å–∫–∞—è
                                <span class="checkmark"></span>
                            </div>
                            <div class="language-option" data-lang="kk">
                                üá∞üáø “ö–∞–∑–∞“õ—à–∞
                                <span class="checkmark"></span>
                            </div>
                            <div class="language-option" data-lang="fr">
                                üá´üá∑ Fran√ßais
                                <span class="checkmark"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        'use strict';
        (function() {
            const Telegram = window.Telegram.WebApp;
            Telegram.expand();
            Telegram.BackButton.hide();

            const decryptApiKey = () => {
                const encrypted = "c2stb3ItdjEtYjc2YjFkMTg3MDE5OGNhM2FkNWI0MGI4NzgyYjViNTYyY2EwYTQ4MmIzZThkODRiMDA3Njg0NzM3MjA0NzkwMA==";
                return atob(encrypted);
            };

            const OPENROUTER_API_KEY = decryptApiKey();
            const API_URL = "https://openrouter.ai/api/v1/chat/completions";
            
            const state = {
                currentChatId: 'default',
                chats: {},
                userSettings: {
                    language: 'ru',
                    theme: 'light',
                    sidebarHidden: false
                },
                messageRatings: {}
            };

            const loadFromStorage = (key, defaultValue) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch {
                    return defaultValue;
                }
            };

            const saveToStorage = (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        Object.keys(state.chats).forEach(id => {
                            if (state.chats[id].messages.length > 100) {
                                state.chats[id].messages = state.chats[id].messages.slice(-100);
                            }
                        });
                        localStorage.setItem(key, JSON.stringify(data));
                    }
                }
            };

            const escapeHtml = (text) => {
                if (typeof text !== 'string') return text;
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };

            const sanitizeInput = (input) => {
                if (typeof input !== 'string') return '';
                return input.slice(0, 2000).replace(/[<>]/g, '').trim();
            };

            const validateMessage = (message) => {
                if (!message || typeof message !== 'string') return false;
                if (message.length > 2000) return false;
                return message.trim().length > 0;
            };

            const texts = {
                ru: {
                    welcomeTitle: "NeuroFlora",
                    welcomeSubtitle: "–í–∞—à AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ —Å–∞–¥–æ–≤–æ–¥—Å—Ç–≤—É. –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö, —É—Ö–æ–¥–µ –∑–∞ –Ω–∏–º–∏, –±–æ–ª–µ–∑–Ω—è—Ö –∏ —É–¥–æ–±—Ä–µ–Ω–∏—è—Ö.",
                    placeholder: "–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –æ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö...",
                    typing: "–ü–µ—á–∞—Ç–∞–µ—Ç...",
                    rateHelpful: "–ü–æ–ª–µ–∑–Ω–æ",
                    rateNotHelpful: "–ù–µ –ø–æ–ª–µ–∑–Ω–æ",
                    copy: "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
                    delete: "–£–¥–∞–ª–∏—Ç—å",
                    regenerate: "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ",
                    noHistory: "–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞",
                    totalQuestions: "–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤",
                    helpfulAnswers: "–ü–æ–ª–µ–∑–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤",
                    language: "–Ø–∑—ã–∫",
                    newChat: "–ù–æ–≤—ã–π —á–∞—Ç",
                    clearChat: "–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç",
                    settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏",
                    online: "–û–Ω–ª–∞–π–Ω",
                    aiDisclaimer: "–û—Ç–≤–µ—Ç—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º –∏ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –æ—à–∏–±–∫–∏. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.",
                    languageChanged: "–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω",
                    chatCleared: "–ß–∞—Ç –æ—á–∏—â–µ–Ω",
                    confirmClear: "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.",
                    confirmDeleteChat: "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.",
                    sendError: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
                    copySuccess: "–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω",
                    exampleQuestions: [
                        "–ö–∞–∫ —É—Ö–∞–∂–∏–≤–∞—Ç—å –∑–∞ –æ—Ä—Ö–∏–¥–µ–µ–π?",
                        "–ü–æ—á–µ–º—É –∂–µ–ª—Ç–µ—é—Ç –ª–∏—Å—Ç—å—è —É —Ñ–∏–∫—É—Å–∞?",
                        "–ö–∞–∫–∏–µ —É–¥–æ–±—Ä–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Ä–æ–∑?",
                        "–ö–∞–∫ —á–∞—Å—Ç–æ –ø–æ–ª–∏–≤–∞—Ç—å –∫–∞–∫—Ç—É—Å—ã?"
                    ],
                    chat: "–ß–∞—Ç",
                    history: "–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤",
                    stats: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
                    interfaceLanguage: "–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"
                },
                en: {
                    welcomeTitle: "NeuroFlora",
                    welcomeSubtitle: "Your AI gardening assistant. Ask questions about plants, care, diseases and fertilizers.",
                    placeholder: "Ask a question about plants...",
                    typing: "Typing...",
                    rateHelpful: "Helpful",
                    rateNotHelpful: "Not helpful",
                    copy: "Copy",
                    delete: "Delete",
                    regenerate: "Regenerate",
                    noHistory: "No history",
                    totalQuestions: "Total questions",
                    helpfulAnswers: "Helpful answers",
                    language: "Language",
                    newChat: "New chat",
                    clearChat: "Clear chat",
                    settings: "Settings",
                    online: "Online",
                    aiDisclaimer: "Responses are generated by artificial intelligence and may contain errors. Verify important information.",
                    languageChanged: "Language changed",
                    chatCleared: "Chat cleared",
                    confirmClear: "Are you sure you want to clear the chat? All messages will be deleted.",
                    confirmDeleteChat: "Delete this chat? This action cannot be undone.",
                    sendError: "Error sending message. Please try again.",
                    copySuccess: "Text copied",
                    exampleQuestions: [
                        "How to care for an orchid?",
                        "Why do ficus leaves turn yellow?",
                        "What fertilizers are suitable for roses?",
                        "How often to water cacti?"
                    ],
                    chat: "Chat",
                    history: "Chat History",
                    stats: "Statistics",
                    interfaceLanguage: "Interface language"
                },
                uk: {
                    welcomeTitle: "NeuroFlora",
                    welcomeSubtitle: "–í–∞—à AI-–ø–æ–º—ñ—á–Ω–∏–∫ –∑ —Å–∞–¥—ñ–≤–Ω–∏—Ü—Ç–≤–∞. –ó–∞–¥–∞–≤–∞–π—Ç–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Ä–æ—Å–ª–∏–Ω–∏, –¥–æ–≥–ª—è–¥, —Ö–≤–æ—Ä–æ–±–∏ —Ç–∞ –¥–æ–±—Ä–∏–≤–∞.",
                    placeholder: "–ó–∞–¥–∞–π—Ç–µ –ø–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ —Ä–æ—Å–ª–∏–Ω–∏...",
                    typing: "–î—Ä—É–∫—É—î...",
                    rateHelpful: "–ö–æ—Ä–∏—Å–Ω–æ",
                    rateNotHelpful: "–ù–µ –∫–æ—Ä–∏—Å–Ω–æ",
                    copy: "–ö–æ–ø—ñ—é–≤–∞—Ç–∏",
                    delete: "–í–∏–¥–∞–ª–∏—Ç–∏",
                    regenerate: "–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É",
                    noHistory: "–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è",
                    totalQuestions: "–í—Å—å–æ–≥–æ –ø–∏—Ç–∞–Ω—å",
                    helpfulAnswers: "–ö–æ—Ä–∏—Å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π",
                    language: "–ú–æ–≤–∞",
                    newChat: "–ù–æ–≤–∏–π —á–∞—Ç",
                    clearChat: "–û—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç",
                    settings: "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
                    online: "–û–Ω–ª–∞–π–Ω",
                    aiDisclaimer: "–í—ñ–¥–ø–æ–≤—ñ–¥—ñ –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è —à—Ç—É—á–Ω–∏–º —ñ–Ω—Ç–µ–ª–µ–∫—Ç–æ–º —ñ –º–æ–∂—É—Ç—å –º—ñ—Å—Ç–∏—Ç–∏ –ø–æ–º–∏–ª–∫–∏. –ü–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ –≤–∞–∂–ª–∏–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é.",
                    languageChanged: "–ú–æ–≤—É –∑–º—ñ–Ω–µ–Ω–æ",
                    chatCleared: "–ß–∞—Ç –æ—á–∏—â–µ–Ω–æ",
                    confirmClear: "–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –æ—á–∏—Å—Ç–∏—Ç–∏ —á–∞—Ç? –£—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ.",
                    confirmDeleteChat: "–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π —á–∞—Ç? –¶—é –¥—ñ—é –Ω–µ –º–æ–∂–Ω–∞ —Å–∫–∞—Å—É–≤–∞—Ç–∏.",
                    sendError: "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.",
                    copySuccess: "–¢–µ–∫—Å—Ç —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ",
                    exampleQuestions: [
                        "–Ø–∫ –¥–æ–≥–ª—è–¥–∞—Ç–∏ –∑–∞ –æ—Ä—Ö—ñ–¥–µ—î—é?",
                        "–ß–æ–º—É –∂–æ–≤—Ç—ñ—é—Ç—å –ª–∏—Å—Ç—è —É —Ñ—ñ–∫—É—Å–∞?",
                        "–Ø–∫—ñ –¥–æ–±—Ä–∏–≤–∞ –ø—ñ–¥—Ö–æ–¥—è—Ç—å –¥–ª—è —Ç—Ä–æ—è–Ω–¥?",
                        "–Ø–∫ —á–∞—Å—Ç–æ –ø–æ–ª–∏–≤–∞—Ç–∏ –∫–∞–∫—Ç—É—Å–∏?"
                    ],
                    chat: "–ß–∞—Ç",
                    history: "–Ü—Å—Ç–æ—Ä—ñ—è —á–∞—Ç—ñ–≤",
                    stats: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
                    interfaceLanguage: "–ú–æ–≤–∞ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É"
                },
                be: {
                    welcomeTitle: "NeuroFlora",
                    welcomeSubtitle: "–í–∞—à AI-–ø–∞–º–æ—á–Ω—ñ–∫ –ø–∞ —Å–∞–¥–æ—û–Ω—ñ—Ü—Ç–≤–µ. –ó–∞–¥–∞–≤–∞–π—Ü–µ –ø—ã—Ç–∞–Ω–Ω—ñ –ø—Ä–∞ —Ä–∞—Å–ª—ñ–Ω—ã, –¥–æ–≥–ª—è–¥, —Ö–≤–∞—Ä–æ–±—ã —ñ —û–≥–Ω–∞–µ–Ω–Ω—ñ.",
                    placeholder: "–ó–∞–¥–∞–π—Ü–µ –ø—ã—Ç–∞–Ω–Ω–µ –ø—Ä–∞ —Ä–∞—Å–ª—ñ–Ω—ã...",
                    typing: "–î—Ä—É–∫—É–µ...",
                    rateHelpful: "–ö–∞—Ä—ã—Å–Ω–∞",
                    rateNotHelpful: "–ù–µ –∫–∞—Ä—ã—Å–Ω–∞",
                    copy: "–ö–∞–ø—ñ—è–≤–∞—Ü—å",
                    delete: "–í—ã–¥–∞–ª—ñ—Ü—å",
                    regenerate: "–ó–≥–µ–Ω–µ—Ä–∞–≤–∞—Ü—å –Ω–∞–Ω–æ–≤–∞",
                    noHistory: "–ì—ñ—Å—Ç–æ—Ä—ã—è –ø—É—Å—Ç–∞—è",
                    totalQuestions: "–£—Å—è–≥–æ –ø—ã—Ç–∞–Ω–Ω—è—û",
                    helpfulAnswers: "–ö–∞—Ä—ã—Å–Ω—ã—Ö –∞–¥–∫–∞–∑–∞—û",
                    language: "–ú–æ–≤–∞",
                    newChat: "–ù–æ–≤—ã —á–∞—Ç",
                    clearChat: "–ê—á—ã—Å—Ü—ñ—Ü—å —á–∞—Ç",
                    settings: "–ù–∞–ª–∞–¥—ã",
                    online: "–Å–Ω–ª–∞–π–Ω",
                    aiDisclaimer: "–ê–¥–∫–∞–∑—ã –≥–µ–Ω–µ—Ä—É—é—Ü—Ü–∞ —à—Ç—É—á–Ω—ã–º —ñ–Ω—Ç—ç–ª–µ–∫—Ç–∞–º —ñ –º–æ–≥—É—Ü—å —É—Ç—Ä—ã–º–ª—ñ–≤–∞—Ü—å –ø–∞–º—ã–ª–∫—ñ. –ü—Ä–∞–≤—è—Ä–∞–π—Ü–µ –≤–∞–∂–Ω—É—é —ñ–Ω—Ñ–∞—Ä–º–∞—Ü—ã—é.",
                    languageChanged: "–ú–æ–≤—É –∑–º–µ–Ω–µ–Ω–∞",
                    chatCleared: "–ß–∞—Ç –∞—á—ã—à—á–∞–Ω—ã",
                    confirmClear: "–í—ã —û–ø—ç—û–Ω–µ–Ω—ã, —à—Ç–æ —Ö–æ—á–∞—Ü–µ –∞—á—ã—Å—Ü—ñ—Ü—å —á–∞—Ç? –£—Å–µ –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—ñ –±—É–¥—É—Ü—å –≤—ã–¥–∞–ª–µ–Ω—ã.",
                    confirmDeleteChat: "–í—ã–¥–∞–ª—ñ—Ü—å –≥—ç—Ç—ã —á–∞—Ç? –ì—ç—Ç–∞ –¥–∑–µ—è–Ω–Ω–µ –Ω–µ–ª—å–≥–∞ –∞–¥–º—è–Ω—ñ—Ü—å.",
                    sendError: "–ü–∞–º—ã–ª–∫–∞ –ø—Ä—ã –∞–¥–ø—Ä–∞—û—Ü—ã –ø–∞–≤–µ–¥–∞–º–ª–µ–Ω–Ω—è. –ü–∞—Å–ø—Ä–∞–±—É–π—Ü–µ —è—à—á—ç —Ä–∞–∑.",
                    copySuccess: "–¢—ç–∫—Å—Ç —Å–∫–∞–ø—ñ—è–≤–∞–Ω—ã",
                    exampleQuestions: [
                        "–Ø–∫ –¥–∞–≥–ª—è–¥–∞—Ü—å –∑–∞ –∞—Ä—Ö—ñ–¥—ç—è–π?",
                        "–ß–∞–º—É –∂–∞—û—Ü–µ—é—Ç—å –ª—ñ—Å—Ü–µ —û —Ñ—ñ–∫—É—Å–∞?",
                        "–Ø–∫—ñ—è —û–≥–Ω–∞–µ–Ω–Ω—ñ –ø–∞–¥—ã—Ö–æ–¥–∑—è—Ü—å –¥–ª—è —Ä—É–∂?",
                        "–Ø–∫ —á–∞—Å—Ç–∞ –ø–∞–ª—ñ–≤–∞—Ü—å –∫–∞–∫—Ç—É—Å—ã?"
                    ],
                    chat: "–ß–∞—Ç",
                    history: "–ì—ñ—Å—Ç–æ—Ä—ã—è —á–∞—Ç–∞—û",
                    stats: "–°—Ç–∞—Ç—ã—Å—Ç—ã–∫–∞",
                    interfaceLanguage: "–ú–æ–≤–∞ —ñ–Ω—Ç—ç—Ä—Ñ–µ–π—Å—É"
                },
                kk: {
                    welcomeTitle: "NeuroFlora",
                    welcomeSubtitle: "–°—ñ–∑–¥—ñ“£ AI –±–∞“õ—à–∞ –∫”©–º–µ–∫—à—ñ—Å—ñ“£—ñ–∑. ”®—Å—ñ–º–¥—ñ–∫—Ç–µ—Ä, –∫“Ø—Ç—ñ–º, –∞—É—Ä—É–ª–∞—Ä –∂”ô–Ω–µ —Ç—ã“£–∞–π—Ç“õ—ã—à—Ç–∞—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞“õ—Ç–∞—Ä “õ–æ–π—ã“£—ã–∑.",
                    placeholder: "”®—Å—ñ–º–¥—ñ–∫—Ç–µ—Ä —Ç—É—Ä–∞–ª—ã —Å“±—Ä–∞“õ “õ–æ–π—ã“£—ã–∑...",
                    typing: "–¢–µ—Ä—ñ–ª–µ–¥—ñ...",
                    rateHelpful: "–ü–∞–π–¥–∞–ª—ã",
                    rateNotHelpful: "–ü–∞–π–¥–∞—Å—ã–∑",
                    copy: "–ö”©—à—ñ—Ä—É",
                    delete: "–ñ–æ—é",
                    regenerate: "“ö–∞–π—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è–ª–∞—É",
                    noHistory: "–¢–∞—Ä–∏—Ö—ã –±–æ—Å",
                    totalQuestions: "–ë–∞—Ä–ª—ã“õ —Å“±—Ä–∞“õ—Ç–∞—Ä",
                    helpfulAnswers: "–ü–∞–π–¥–∞–ª—ã –∂–∞—É–∞–ø—Ç–∞—Ä",
                    language: "–¢—ñ–ª",
                    newChat: "–ñ–∞“£–∞ —á–∞—Ç",
                    clearChat: "–ß–∞—Ç—Ç—ã —Ç–∞–∑–∞–ª–∞—É",
                    settings: "–ë–∞–ø—Ç–∞—É–ª–∞—Ä",
                    online: "–û–Ω–ª–∞–π–Ω",
                    aiDisclaimer: "–ñ–∞—É–∞–ø—Ç–∞—Ä –∂–∞—Å–∞–Ω–¥—ã –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∞—Ä“õ—ã–ª—ã –∂–∞—Å–∞–ª–∞–¥—ã –∂”ô–Ω–µ “õ–∞—Ç–µ–ª–µ—Ä—ñ –±–æ–ª—É—ã –º“Ø–º–∫—ñ–Ω. –ú–∞“£—ã–∑–¥—ã –∞“õ–ø–∞—Ä–∞—Ç—Ç—ã —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.",
                    languageChanged: "–¢—ñ–ª ”©–∑–≥–µ—Ä—Ç—ñ–ª–¥—ñ",
                    chatCleared: "–ß–∞—Ç —Ç–∞–∑–∞–ª–∞–Ω–¥—ã",
                    confirmClear: "–ß–∞—Ç—Ç—ã —Ç–∞–∑–∞–ª–∞“ì—ã“£—ã–∑ –∫–µ–ª–µ—Ç—ñ–Ω—ñ–Ω–µ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ? –ë–∞—Ä–ª—ã“õ —Ö–∞–±–∞—Ä–ª–∞–º–∞–ª–∞—Ä –∂–æ–π—ã–ª–∞–¥—ã.",
                    confirmDeleteChat: "–ë“±–ª —á–∞—Ç—Ç—ã –∂–æ—é –∫–µ—Ä–µ–∫ –ø–µ? –ë“±–ª ”ô—Ä–µ–∫–µ—Ç—Ç—ñ –±–æ–ª–¥—ã—Ä–º–∞—É –º“Ø–º–∫—ñ–Ω –µ–º–µ—Å.",
                    sendError: "–•–∞–±–∞—Ä–ª–∞–º–∞–Ω—ã –∂—ñ–±–µ—Ä—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã. “ö–∞–π—Ç–∞–ª–∞–ø –∫”©—Ä—ñ“£—ñ–∑.",
                    copySuccess: "–ú”ô—Ç—ñ–Ω –∫”©—à—ñ—Ä—ñ–ª–¥—ñ",
                    exampleQuestions: [
                        "–û—Ä—Ö–∏–¥–µ—è“ì–∞ “õ–∞–ª–∞–π –∫“Ø—Ç—ñ–º –∂–∞—Å–∞—É –∫–µ—Ä–µ–∫?",
                        "–§–∏–∫—É—Å—Ç—ã“£ –∂–∞–ø—ã—Ä–∞“õ—Ç–∞—Ä—ã –Ω–µ–≥–µ —Å–∞—Ä—ã“ì–∞ –±–æ—è–ª–∞–¥—ã?",
                        "–†–∞—É—à–∞–Ω“ì–∞ “õ–∞–Ω–¥–∞–π —Ç—ã“£–∞–π—Ç“õ—ã—à—Ç–∞—Ä –∂–∞—Ä–∞—Å–∞–¥—ã?",
                        "–ö–∞–∫—Ç—É—Å—Ç–∞—Ä–¥—ã “õ–∞–Ω—à–∞–ª—ã“õ—Ç—ã –∂–∏—ñ —Å—É“ì–∞—Ä—É –∫–µ—Ä–µ–∫?"
                    ],
                    chat: "–ß–∞—Ç",
                    history: "–ß–∞—Ç —Ç–∞—Ä–∏—Ö—ã",
                    stats: "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
                    interfaceLanguage: "–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ç—ñ–ª—ñ"
                },
                fr: {
                    welcomeTitle: "NeuroFlora",
                    welcomeSubtitle: "Votre assistant IA de jardinage. Posez des questions sur les plantes, les soins, les maladies et les engrais.",
                    placeholder: "Posez une question sur les plantes...",
                    typing: "En train d'√©crire...",
                    rateHelpful: "Utile",
                    rateNotHelpful: "Pas utile",
                    copy: "Copier",
                    delete: "Supprimer",
                    regenerate: "R√©g√©n√©rer",
                    noHistory: "Aucun historique",
                    totalQuestions: "Questions totales",
                    helpfulAnswers: "R√©ponses utiles",
                    language: "Langue",
                    newChat: "Nouveau chat",
                    clearChat: "Effacer le chat",
                    settings: "Param√®tres",
                    online: "En ligne",
                    aiDisclaimer: "Les r√©ponses sont g√©n√©r√©es par l'intelligence artificielle et peuvent contenir des erreurs. V√©rifiez les informations importantes.",
                    languageChanged: "Langue chang√©e",
                    chatCleared: "Chat effac√©",
                    confirmClear: "√ätes-vous s√ªr de vouloir effacer le chat ? Tous les messages seront supprim√©s.",
                    confirmDeleteChat: "Supprimer ce chat ? Cette action ne peut pas √™tre annul√©e.",
                    sendError: "Erreur lors de l'envoi du message. Veuillez r√©essayer.",
                    copySuccess: "Texte copi√©",
                    exampleQuestions: [
                        "Comment entretenir une orchid√©e ?",
                        "Pourquoi les feuilles de ficus jaunissent-elles ?",
                        "Quels engrais conviennent aux roses ?",
                        "√Ä quelle fr√©quence arroser les cactus ?"
                    ],
                    chat: "Chat",
                    history: "Historique des chats",
                    stats: "Statistiques",
                    interfaceLanguage: "Langue de l'interface"
                }
            };

            const DOM = {
                sidebar: document.getElementById('sidebar'),
                messageInput: document.getElementById('message-input'),
                sendButton: document.getElementById('send-button'),
                messagesContainer: document.getElementById('messages-container'),
                welcomeMessage: document.getElementById('welcome-message'),
                historyList: document.getElementById('history-list'),
                settingsModal: document.getElementById('settings-modal'),
                userAvatar: document.getElementById('user-avatar'),
                userName: document.getElementById('user-name'),
                sidebarToggle: document.getElementById('sidebar-toggle'),
                menuToggle: document.getElementById('menu-toggle'),
                newChatBtn: document.getElementById('new-chat-btn'),
                clearChatBtn: document.getElementById('clear-chat'),
                themeToggle: document.getElementById('theme-toggle'),
                settingsBtn: document.getElementById('settings-btn'),
                modalClose: document.getElementById('modal-close'),
                charCount: document.querySelector('.char-count'),
                aiDisclaimer: document.getElementById('ai-disclaimer'),
                currentChatTitle: document.getElementById('current-chat-title'),
                mobileOverlay: document.getElementById('mobile-overlay'),
                chatContainer: document.getElementById('chat-container')
            };

            const API = {
                async generateAIResponse(question) {
                    const controller = new AbortController();
                    setTimeout(() => controller.abort(), 30000);

                    try {
                        const headers = {
                            "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                            "Content-Type": "application/json",
                            "HTTP-Referer": window.location.origin,
                            "X-Title": "NeuroFlora"
                        };

                        const languagePrompts = {
                            ru: "–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.",
                            en: "Respond in English.",
                            uk: "–í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é.",
                            be: "–ê–¥–∫–∞–∑–≤–∞–π –Ω–∞ –±–µ–ª–∞—Ä—É—Å–∫–∞–π –º–æ–≤–µ.",
                            kk: "“ö–∞–∑–∞“õ —Ç—ñ–ª—ñ–Ω–¥–µ –∂–∞—É–∞–ø –±–µ—Ä.",
                            fr: "R√©pondez en fran√ßais."
                        };

                        const prompt = `–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π —Å–∞–¥–æ–≤–æ–¥. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ä–∞—Å—Ç–µ–Ω–∏—è—Ö —á–µ—Ç–∫–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ.
${languagePrompts[state.userSettings.language] || languagePrompts.ru}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Å–∞–¥–æ–≤–æ–¥—Å—Ç–≤–µ
2. –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º
3. –ò—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
4. –û–±—ä–µ–º –æ—Ç–≤–µ—Ç–∞ –Ω–µ –±–æ–ª–µ–µ 500 —Å–ª–æ–≤
5. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º, –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º

–í–æ–ø—Ä–æ—Å: ${sanitizeInput(question)}`;

                        const data = {
                            model: "openai/gpt-3.5-turbo",
                            messages: [
                                {
                                    role: "system",
                                    content: "–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Å–∞–¥–æ–≤–æ–¥. –û—Ç–≤–µ—á–∞–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω–æ."
                                },
                                {
                                    role: "user",
                                    content: prompt
                                }
                            ],
                            max_tokens: 1000,
                            temperature: 0.7
                        };

                        const response = await fetch(API_URL, {
                            method: "POST",
                            headers,
                            body: JSON.stringify(data),
                            signal: controller.signal
                        });

                        if (!response.ok) {
                            throw new Error(`API Error: ${response.status}`);
                        }

                        const result = await response.json();
                        const content = result.choices[0].message.content.trim();
                        return sanitizeInput(content);
                    } catch (error) {
                        if (error.name === 'AbortError') {
                            throw new Error('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞');
                        }
                        throw error;
                    }
                }
            };

            const Utils = {
                formatTime: (dateString) => {
                    const date = new Date(dateString);
                    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                },

                autoResizeTextarea: (textarea) => {
                    textarea.style.height = 'auto';
                    const maxHeight = 120;
                    const scrollHeight = textarea.scrollHeight;
                    textarea.style.height = Math.min(scrollHeight, maxHeight) + 'px';
                },

                isMobile: () => window.innerWidth <= 768,

                scrollToBottom: () => {
                    requestAnimationFrame(() => {
                        DOM.chatContainer.scrollTop = DOM.chatContainer.scrollHeight;
                    });
                }
            };

            const App = {
                init() {
                    state.chats = loadFromStorage('neuroflora_chats', {
                        default: {
                            id: 'default',
                            title: '–ù–æ–≤—ã–π —á–∞—Ç',
                            messages: [],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        }
                    });
                    
                    state.userSettings = loadFromStorage('neuroflora_settings', {
                        language: Telegram.initDataUnsafe.user?.language_code || 'ru',
                        theme: 'light',
                        sidebarHidden: false
                    });
                    
                    state.messageRatings = loadFromStorage('neuroflora_ratings', {});
                    
                    this.setupUserProfile();
                    this.loadCurrentChat();
                    this.setupEventListeners();
                    this.updateInterfaceLanguage();
                    this.updateStatistics();
                    this.loadHistoryList();
                    this.updateSidebarState();
                    this.applyTheme();
                    this.updateCharCount();
                    this.handleMobileView();
                },

                setupUserProfile() {
                    const user = Telegram.initDataUnsafe.user;
                    if (user) {
                        const userName = user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                        DOM.userName.textContent = escapeHtml(userName);
                        
                        if (user.photo_url) {
                            DOM.userAvatar.style.backgroundImage = `url('${escapeHtml(user.photo_url)}')`;
                            DOM.userAvatar.style.backgroundSize = 'cover';
                            DOM.userAvatar.textContent = '';
                        } else {
                            DOM.userAvatar.textContent = userName.charAt(0).toUpperCase();
                        }
                    }
                },

                loadCurrentChat() {
                    const chat = state.chats[state.currentChatId];
                    DOM.messagesContainer.innerHTML = '';
                    
                    if (chat.messages.length === 0) {
                        DOM.welcomeMessage.style.display = 'flex';
                        DOM.welcomeMessage.classList.add('show');
                    } else {
                        DOM.welcomeMessage.style.display = 'none';
                        DOM.welcomeMessage.classList.remove('show');
                        chat.messages.forEach(msg => this.renderMessage(msg));
                        Utils.scrollToBottom();
                    }
                    
                    this.updateChatHeader();
                },

                renderMessage(msg) {
                    if (msg.id === 'welcome') return;
                    
                    const t = texts[state.userSettings.language];
                    const time = Utils.formatTime(msg.timestamp);
                    const isUserMessage = msg.role === 'user';
                    const author = isUserMessage 
                        ? (Telegram.initDataUnsafe.user?.first_name || '–í—ã') 
                        : 'NeuroFlora';
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${isUserMessage ? 'user-message' : 'bot-message'}`;
                    messageDiv.id = `message-${msg.id}`;
                    
                    const messageContainer = document.createElement('div');
                    messageContainer.className = 'message-container';
                    
                    const avatar = document.createElement('div');
                    avatar.className = `message-avatar ${isUserMessage ? 'user-avatar-sm' : 'bot-avatar-sm'}`;
                    
                    if (isUserMessage && Telegram.initDataUnsafe.user?.photo_url) {
                        avatar.style.backgroundImage = `url('${escapeHtml(Telegram.initDataUnsafe.user.photo_url)}')`;
                        avatar.style.backgroundSize = 'cover';
                        avatar.textContent = '';
                    } else if (isUserMessage) {
                        const userName = Telegram.initDataUnsafe.user?.first_name || '–í—ã';
                        avatar.textContent = userName.charAt(0).toUpperCase();
                    }
                    
                    const contentWrapper = document.createElement('div');
                    contentWrapper.className = 'message-content-wrapper';
                    
                    const header = document.createElement('div');
                    header.className = 'message-header';
                    
                    const authorEl = document.createElement('div');
                    authorEl.className = 'message-author';
                    authorEl.textContent = author;
                    
                    const timeEl = document.createElement('div');
                    timeEl.className = 'message-time';
                    timeEl.textContent = time;
                    
                    header.appendChild(authorEl);
                    header.appendChild(timeEl);
                    
                    const content = document.createElement('div');
                    content.className = 'message-content';
                    content.textContent = msg.content.trim();
                    
                    contentWrapper.appendChild(header);
                    contentWrapper.appendChild(content);
                    
                    if (!isUserMessage) {
                        const rating = state.messageRatings[msg.id];
                        const chat = state.chats[state.currentChatId];
                        const isLastAIMessage = chat.messages[chat.messages.length - 1]?.id === msg.id;
                        
                        const actions = document.createElement('div');
                        actions.className = 'message-actions';
                        
                        const likeBtn = document.createElement('button');
                        likeBtn.className = `action-btn ${rating === 'like' ? 'active' : ''}`;
                        likeBtn.innerHTML = DOMPurify.sanitize(`<i class="fas fa-thumbs-up"></i> ${t.rateHelpful}`);
                        likeBtn.onclick = () => this.rateMessage(msg.id, 'like');
                        
                        const dislikeBtn = document.createElement('button');
                        dislikeBtn.className = `action-btn ${rating === 'dislike' ? 'active' : ''}`;
                        dislikeBtn.innerHTML = DOMPurify.sanitize(`<i class="fas fa-thumbs-down"></i> ${t.rateNotHelpful}`);
                        dislikeBtn.onclick = () => this.rateMessage(msg.id, 'dislike');
                        
                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'action-btn';
                        copyBtn.innerHTML = DOMPurify.sanitize(`<i class="fas fa-copy"></i> ${t.copy}`);
                        copyBtn.onclick = () => this.copyMessage(msg.id);
                        
                        actions.appendChild(likeBtn);
                        actions.appendChild(dislikeBtn);
                        actions.appendChild(copyBtn);
                        
                        if (isLastAIMessage) {
                            const regenerateBtn = document.createElement('button');
                            regenerateBtn.className = 'action-btn';
                            regenerateBtn.innerHTML = DOMPurify.sanitize(`<i class="fas fa-redo"></i> ${t.regenerate}`);
                            regenerateBtn.onclick = () => this.regenerateResponse(msg.id);
                            actions.appendChild(regenerateBtn);
                        }
                        
                        contentWrapper.appendChild(actions);
                    }
                    
                    messageContainer.appendChild(avatar);
                    messageContainer.appendChild(contentWrapper);
                    messageDiv.appendChild(messageContainer);
                    DOM.messagesContainer.appendChild(messageDiv);
                },

                async sendMessage() {
                    const input = DOM.messageInput;
                    const text = sanitizeInput(input.value);
                    
                    if (!validateMessage(text)) {
                        Telegram.WebApp.showAlert("–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã");
                        return;
                    }
                    
                    DOM.sendButton.disabled = true;
                    
                    const userMessage = {
                        id: Date.now().toString(),
                        role: 'user',
                        content: text,
                        timestamp: new Date().toISOString()
                    };
                    
                    this.addMessageToChat(userMessage);
                    this.renderMessage(userMessage);
                    
                    input.value = '';
                    this.updateCharCount();
                    Utils.autoResizeTextarea(input);
                    
                    DOM.welcomeMessage.style.display = 'none';
                    DOM.welcomeMessage.classList.remove('show');
                    
                    Utils.scrollToBottom();
                    this.showTypingIndicator();
                    
                    try {
                        const aiResponse = await API.generateAIResponse(text);
                        this.hideTypingIndicator();
                        
                        const aiMessage = {
                            id: Date.now().toString(),
                            role: 'assistant',
                            content: aiResponse,
                            timestamp: new Date().toISOString()
                        };
                        
                        this.addMessageToChat(aiMessage);
                        this.renderMessage(aiMessage);
                        
                        this.updateChatTitle();
                        this.loadHistoryList();
                        this.updateStatistics();
                        
                        Utils.scrollToBottom();
                        Telegram.HapticFeedback.notificationOccurred('success');
                    } catch (error) {
                        this.hideTypingIndicator();
                        const t = texts[state.userSettings.language];
                        const errorMessage = {
                            id: Date.now().toString(),
                            role: 'assistant',
                            content: error.message || t.sendError,
                            timestamp: new Date().toISOString()
                        };
                        
                        this.addMessageToChat(errorMessage);
                        this.renderMessage(errorMessage);
                        Utils.scrollToBottom();
                        Telegram.HapticFeedback.notificationOccurred('error');
                    } finally {
                        DOM.sendButton.disabled = false;
                    }
                },

                async regenerateResponse(messageId) {
                    const chat = state.chats[state.currentChatId];
                    const messageIndex = chat.messages.findIndex(m => m.id === messageId);
                    
                    if (messageIndex === -1 || chat.messages[messageIndex].role !== 'assistant') return;
                    
                    const userMessage = chat.messages[messageIndex - 1];
                    if (!userMessage || userMessage.role !== 'user') return;
                    
                    chat.messages.splice(messageIndex, 1);
                    this.saveChats();
                    this.loadCurrentChat();
                    
                    this.showTypingIndicator();
                    
                    try {
                        const aiResponse = await API.generateAIResponse(userMessage.content);
                        this.hideTypingIndicator();
                        
                        const aiMessage = {
                            id: Date.now().toString(),
                            role: 'assistant',
                            content: aiResponse,
                            timestamp: new Date().toISOString()
                        };
                        
                        this.addMessageToChat(aiMessage);
                        this.renderMessage(aiMessage);
                        
                        this.updateStatistics();
                        Utils.scrollToBottom();
                        Telegram.HapticFeedback.notificationOccurred('success');
                    } catch (error) {
                        this.hideTypingIndicator();
                        const t = texts[state.userSettings.language];
                        const errorMessage = {
                            id: Date.now().toString(),
                            role: 'assistant',
                            content: error.message || t.sendError,
                            timestamp: new Date().toISOString()
                        };
                        
                        this.addMessageToChat(errorMessage);
                        this.renderMessage(errorMessage);
                        Utils.scrollToBottom();
                        Telegram.HapticFeedback.notificationOccurred('error');
                    }
                },

                addMessageToChat(message) {
                    const chat = state.chats[state.currentChatId];
                    message.content = message.content.trim();
                    chat.messages.push(message);
                    chat.updatedAt = new Date().toISOString();
                    this.saveChats();
                },

                updateChatTitle() {
                    const chat = state.chats[state.currentChatId];
                    const lastUserMessage = chat.messages.find(m => m.role === 'user');
                    if (lastUserMessage && lastUserMessage.content) {
                        const title = lastUserMessage.content.substring(0, 50) + (lastUserMessage.content.length > 50 ? '...' : '');
                        const t = texts[state.userSettings.language];
                        if (chat.title === '–ù–æ–≤—ã–π —á–∞—Ç' || chat.title === t.newChat) {
                            chat.title = title;
                            this.saveChats();
                            this.updateChatHeader();
                        }
                    }
                },

                updateChatHeader() {
                    const chat = state.chats[state.currentChatId];
                    DOM.currentChatTitle.textContent = chat?.title || 'NeuroFlora';
                },

                showTypingIndicator() {
                    const t = texts[state.userSettings.language];
                    const typingDiv = document.createElement('div');
                    typingDiv.className = 'typing-indicator';
                    typingDiv.id = 'typing-indicator';
                    typingDiv.innerHTML = DOMPurify.sanitize(`
                        <div class="bot-avatar-sm" style="background-image: url('https://i.postimg.cc/SxdqDwpy/Bez-nazvania54-20251214232638.png')"></div>
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <div>${t.typing}</div>
                    `);
                    DOM.messagesContainer.appendChild(typingDiv);
                    Utils.scrollToBottom();
                },

                hideTypingIndicator() {
                    const indicator = document.getElementById('typing-indicator');
                    if (indicator) indicator.remove();
                },

                rateMessage(messageId, rating) {
                    state.messageRatings[messageId] = rating;
                    saveToStorage('neuroflora_ratings', state.messageRatings);
                    this.updateStatistics();
                },

                copyMessage(messageId) {
                    const messageDiv = document.getElementById(`message-${messageId}`);
                    if (messageDiv) {
                        const text = messageDiv.querySelector('.message-content').textContent;
                        navigator.clipboard.writeText(text).then(() => {
                            const t = texts[state.userSettings.language];
                            Telegram.WebApp.showAlert(t.copySuccess);
                        });
                    }
                },

                createNewChat() {
                    const chatId = Date.now().toString();
                    const t = texts[state.userSettings.language];
                    const newChat = {
                        id: chatId,
                        title: t.newChat,
                        messages: [],
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    state.chats[chatId] = newChat;
                    state.currentChatId = chatId;
                    this.saveChats();
                    
                    this.loadCurrentChat();
                    this.loadHistoryList();
                    
                    Telegram.HapticFeedback.selectionChanged();
                    if (Utils.isMobile()) this.closeSidebar();
                },

                clearCurrentChat() {
                    const t = texts[state.userSettings.language];
                    if (confirm(t.confirmClear)) {
                        const chat = state.chats[state.currentChatId];
                        chat.messages = [];
                        chat.updatedAt = new Date().toISOString();
                        this.saveChats();
                        
                        this.loadCurrentChat();
                        this.updateStatistics();
                        Telegram.WebApp.showAlert(t.chatCleared);
                    }
                },

                deleteChat(chatId, event) {
                    event?.stopPropagation();
                    const t = texts[state.userSettings.language];
                    if (!confirm(t.confirmDeleteChat)) return;
                    
                    if (chatId === state.currentChatId) {
                        state.currentChatId = 'default';
                        if (!state.chats.default) {
                            state.chats.default = {
                                id: 'default',
                                title: t.newChat,
                                messages: [],
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };
                        }
                        this.loadCurrentChat();
                    }
                    
                    delete state.chats[chatId];
                    this.saveChats();
                    this.loadHistoryList();
                    this.updateStatistics();
                },

                loadHistoryList() {
                    const container = DOM.historyList;
                    const chatIds = Object.keys(state.chats);
                    
                    if (chatIds.length === 0 || (chatIds.length === 1 && state.chats.default.messages.length === 0)) {
                        const t = texts[state.userSettings.language];
                        container.innerHTML = DOMPurify.sanitize(`
                            <div style="padding: 40px 20px; text-align: center; color: var(--text-tertiary);">
                                <i class="fas fa-history" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
                                <div>${t.noHistory}</div>
                            </div>
                        `);
                        return;
                    }
                    
                    const sortedChats = chatIds
                        .map(id => state.chats[id])
                        .filter(chat => chat.messages.length > 0 || chat.id === state.currentChatId)
                        .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    
                    container.innerHTML = '';
                    
                    sortedChats.forEach(chat => {
                        const lastMessage = chat.messages[chat.messages.length - 1];
                        let preview;
                        if (lastMessage) {
                            const cleanContent = lastMessage.content.trim();
                            preview = cleanContent.substring(0, 50) + (cleanContent.length > 50 ? '...' : '');
                        } else {
                            const t = texts[state.userSettings.language];
                            preview = t.newChat;
                        }
                        
                        const time = new Date(chat.updatedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        const historyItem = document.createElement('div');
                        historyItem.className = `history-item ${chat.id === state.currentChatId ? 'active' : ''}`;
                        
                        const historyPreview = document.createElement('div');
                        historyPreview.className = 'history-preview';
                        
                        const historyText = document.createElement('div');
                        historyText.className = 'history-text';
                        historyText.textContent = preview;
                        
                        const historyTime = document.createElement('div');
                        historyTime.className = 'history-time';
                        historyTime.textContent = time;
                        
                        historyPreview.appendChild(historyText);
                        historyPreview.appendChild(historyTime);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'history-delete-btn';
                        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                        deleteBtn.onclick = (e) => this.deleteChat(chat.id, e);
                        
                        historyItem.appendChild(historyPreview);
                        historyItem.appendChild(deleteBtn);
                        historyItem.onclick = () => this.switchChat(chat.id);
                        
                        container.appendChild(historyItem);
                    });
                },

                switchChat(chatId) {
                    state.currentChatId = chatId;
                    this.loadCurrentChat();
                    this.loadHistoryList();
                    if (Utils.isMobile()) this.closeSidebar();
                },

                updateInterfaceLanguage() {
                    const lang = state.userSettings.language;
                    const t = texts[lang];
                    
                    DOM.messageInput.placeholder = t.placeholder;
                    document.getElementById('new-chat-text').textContent = t.newChat;
                    document.getElementById('chat-tab-text').textContent = t.chat;
                    document.getElementById('settings-tab-text').textContent = t.settings;
                    document.getElementById('history-title-text').textContent = t.history;
                    document.getElementById('user-status-text').textContent = t.online;
                    document.getElementById('welcome-title').textContent = t.welcomeTitle;
                    document.getElementById('welcome-subtitle').textContent = t.welcomeSubtitle;
                    document.getElementById('ai-disclaimer').textContent = t.aiDisclaimer;
                    document.getElementById('modal-title-text').textContent = t.settings;
                    document.getElementById('stats-title-text').textContent = t.stats;
                    document.getElementById('total-questions-text').textContent = t.totalQuestions;
                    document.getElementById('helpful-answers-text').textContent = t.helpfulAnswers;
                    document.getElementById('language-text').textContent = t.language;
                    document.getElementById('interface-language-text').textContent = t.interfaceLanguage;
                    
                    document.querySelectorAll('.example-card').forEach((card, index) => {
                        const textDiv = card.querySelector('.example-text');
                        if (textDiv && t.exampleQuestions[index]) {
                            textDiv.textContent = t.exampleQuestions[index];
                            card.dataset.question = t.exampleQuestions[index];
                        }
                    });
                    
                    document.querySelectorAll('.language-option').forEach(opt => {
                        opt.classList.toggle('active', opt.dataset.lang === lang);
                    });
                },

                updateStatistics() {
                    const chat = state.chats[state.currentChatId];
                    const totalQuestions = chat.messages.filter(m => m.role === 'user').length;
                    const ratedMessages = Object.values(state.messageRatings);
                    const helpfulCount = ratedMessages.filter(r => r === 'like').length;
                    const helpfulPercentage = ratedMessages.length > 0 ? 
                        Math.round((helpfulCount / ratedMessages.length) * 100) : 0;
                    
                    document.getElementById('stat-total').textContent = totalQuestions;
                    document.getElementById('stat-helpful').textContent = `${helpfulPercentage}%`;
                    document.getElementById('stat-language').textContent = state.userSettings.language.toUpperCase();
                },

                toggleTheme() {
                    const isDark = document.body.classList.toggle('dark-theme');
                    state.userSettings.theme = isDark ? 'dark' : 'light';
                    this.saveSettings();
                    document.getElementById('theme-toggle').querySelector('i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
                },

                toggleSidebar() {
                    if (Utils.isMobile()) {
                        const isActive = DOM.sidebar.classList.toggle('active');
                        DOM.mobileOverlay.classList.toggle('active', isActive);
                        document.body.classList.toggle('no-scroll', isActive);
                    } else {
                        const isHidden = DOM.sidebar.classList.toggle('hidden');
                        state.userSettings.sidebarHidden = isHidden;
                        this.saveSettings();
                        DOM.sidebarToggle.querySelector('i').className = isHidden ? 'fas fa-chevron-left' : 'fas fa-chevron-right';
                    }
                },

                closeSidebar() {
                    if (Utils.isMobile()) {
                        DOM.sidebar.classList.remove('active');
                        DOM.mobileOverlay.classList.remove('active');
                        document.body.classList.remove('no-scroll');
                    }
                },

                updateSidebarState() {
                    if (!Utils.isMobile()) {
                        if (state.userSettings.sidebarHidden) {
                            DOM.sidebar.classList.add('hidden');
                            DOM.sidebarToggle.querySelector('i').className = 'fas fa-chevron-left';
                        } else {
                            DOM.sidebar.classList.remove('hidden');
                            DOM.sidebarToggle.querySelector('i').className = 'fas fa-chevron-right';
                        }
                    }
                },

                applyTheme() {
                    if (state.userSettings.theme === 'dark') {
                        document.body.classList.add('dark-theme');
                        document.getElementById('theme-toggle').querySelector('i').className = 'fas fa-sun';
                    }
                },

                handleMobileView() {
                    if (Utils.isMobile()) {
                        DOM.sidebar.classList.remove('hidden');
                        DOM.sidebar.classList.add('active');
                        setTimeout(() => this.closeSidebar(), 100);
                    }
                },

                updateCharCount() {
                    DOM.charCount.textContent = `${DOM.messageInput.value.length}/2000`;
                },

                saveChats() {
                    saveToStorage('neuroflora_chats', state.chats);
                },

                saveSettings() {
                    saveToStorage('neuroflora_settings', state.userSettings);
                },

                setupEventListeners() {
                    DOM.sendButton.addEventListener('click', () => this.sendMessage());
                    DOM.messageInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                    DOM.messageInput.addEventListener('input', () => {
                        this.updateCharCount();
                        Utils.autoResizeTextarea(DOM.messageInput);
                    });
                    DOM.newChatBtn.addEventListener('click', () => this.createNewChat());
                    DOM.clearChatBtn.addEventListener('click', () => this.clearCurrentChat());
                    DOM.themeToggle.addEventListener('click', () => this.toggleTheme());
                    DOM.menuToggle.addEventListener('click', () => this.toggleSidebar());
                    DOM.sidebarToggle.addEventListener('click', () => this.toggleSidebar());
                    DOM.mobileOverlay.addEventListener('click', () => this.closeSidebar());
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.addEventListener('click', () => {
                            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                            item.classList.add('active');
                            if (Utils.isMobile()) this.closeSidebar();
                        });
                    });
                    DOM.settingsBtn.addEventListener('click', () => {
                        DOM.settingsModal.classList.add('active');
                        this.updateStatistics();
                        Telegram.BackButton.show();
                        if (Utils.isMobile()) this.closeSidebar();
                    });
                    Telegram.BackButton.onClick(() => {
                        DOM.settingsModal.classList.remove('active');
                        Telegram.BackButton.hide();
                    });
                    DOM.modalClose.addEventListener('click', () => {
                        DOM.settingsModal.classList.remove('active');
                        Telegram.BackButton.hide();
                    });
                    DOM.settingsModal.addEventListener('click', (e) => {
                        if (e.target === DOM.settingsModal) {
                            DOM.settingsModal.classList.remove('active');
                            Telegram.BackButton.hide();
                        }
                    });
                    document.querySelectorAll('.language-option').forEach(option => {
                        option.addEventListener('click', () => {
                            const lang = option.dataset.lang;
                            state.userSettings.language = lang;
                            this.saveSettings();
                            this.updateInterfaceLanguage();
                            this.updateStatistics();
                            Telegram.WebApp.showAlert(texts[lang].languageChanged);
                        });
                    });
                    document.querySelectorAll('.example-card').forEach(card => {
                        card.addEventListener('click', () => {
                            const question = card.dataset.question;
                            DOM.messageInput.value = question;
                            Utils.autoResizeTextarea(DOM.messageInput);
                            this.updateCharCount();
                            setTimeout(() => DOM.messageInput.focus(), 100);
                        });
                    });
                    window.addEventListener('resize', () => {
                        this.handleMobileView();
                        if (window.innerWidth > 768) this.closeSidebar();
                    });
                }
            };

            document.addEventListener('DOMContentLoaded', () => App.init());
        })();
    </script>
</body>
</html>
